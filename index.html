<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TK Pickleball Booking</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #ffffff;
      padding: 16px;
      padding-bottom: 100px;
      margin: 0;
      min-height: 100vh;
    }
    h2 {
      margin: 0 0 16px 0;
      font-size: 22px;
      text-align: center;
    }
    .card {
      background: #1e293b;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .card label {
      font-size: 13px;
      color: #94a3b8;
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }
    button {
      padding: 12px 8px;
      border-radius: 10px;
      border: none;
      background: #334155;
      color: #ffffff;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 500;
    }
    button:active {
      transform: scale(0.96);
      opacity: 0.9;
    }
    button.active {
      background: #22c55e;
      color: #000000;
      font-weight: 600;
    }
    button.confirm {
      background: #22c55e;
      color: #000000;
      font-weight: bold;
      width: 100%;
      padding: 16px;
      font-size: 17px;
      margin-top: 12px;
      border-radius: 12px;
    }
    button.confirm:disabled {
      background: #334155;
      color: #64748b;
    }
    input {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: 2px solid #334155;
      font-size: 16px;
      background: #0f172a;
      color: #ffffff;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus {
      border-color: #22c55e;
    }
    input::placeholder {
      color: #64748b;
    }
    .debug {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 13px;
      text-align: center;
      font-weight: 500;
    }
    .debug-green {
      background: #166534;
      color: #bbf7d0;
    }
    .debug-red {
      background: #991b1b;
      color: #fecaca;
    }
    .price-display {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #22c55e;
      margin: 16px 0 8px 0;
    }
    .price-note {
      text-align: center;
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }
    .loading-overlay.show {
      display: flex;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #334155;
      border-top-color: #22c55e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 16px;
      font-size: 16px;
      color: #94a3b8;
    }
  </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Processing your booking...</div>
</div>

<h2>üèì TK Pickleball Booking</h2>

<div class="debug" id="debugBox">Loading...</div>

<div class="card">
  <label>üìõ Your Name</label>
  <input type="text" id="name" placeholder="Enter your name" autocomplete="name">
</div>

<div class="card">
  <label>üì± Phone Number</label>
  <input type="tel" id="phone" placeholder="Enter your phone number" autocomplete="tel">
</div>

<div class="card">
  <label>üìÖ Select Date</label>
  <input type="date" id="date">
</div>

<div class="card">
  <label>‚è± Duration</label>
  <div class="grid grid-3" id="durationBtns">
    <button onclick="selectDuration(this, 1)">1 Hour</button>
    <button onclick="selectDuration(this, 2)">2 Hours</button>
    <button onclick="selectDuration(this, 3)">3 Hours</button>
  </div>
</div>

<div class="card">
  <label>üïê Start Time</label>
  <div class="grid" id="timeBtns">
    <span style="color:#64748b; font-size:14px; grid-column: span 2; text-align: center; padding: 8px;">Select duration first</span>
  </div>
</div>

<div class="card">
  <label>üèü Number of Courts</label>
  <div class="grid grid-4" id="courtBtns">
    <button onclick="selectCourts(this, 1)">1</button>
    <button onclick="selectCourts(this, 2)">2</button>
    <button onclick="selectCourts(this, 3)">3</button>
    <button onclick="selectCourts(this, 4)">4</button>
  </div>
</div>

<div class="price-display" id="priceDisplay">$0</div>
<div class="price-note">$15 per hour per court ‚Ä¢ Pay on arrival</div>

<button class="confirm" id="confirmBtn" onclick="confirmBooking()" disabled>
  Select all options to book
</button>

<script>
// ============================================
// PASTE YOUR GOOGLE APPS SCRIPT URL BELOW
// ============================================
const API_URL = "https://script.google.com/macros/s/AKfycbySlkS8Yb3ACIfh5izbul6FfwTxgzrWg4_SnEMHsC21JyiaC1V9fak4GQFP4w3FvyjYPw/exec";

// Initialize Telegram WebApp
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Get user data from Telegram
const user = tg.initDataUnsafe?.user;
const telegramUserId = user?.id ? String(user.id) : "";
const telegramName = user?.first_name || "";

// Debug display
const debugBox = document.getElementById("debugBox");
if (telegramUserId) {
  debugBox.className = "debug debug-green";
  debugBox.innerHTML = "‚úÖ Welcome, " + telegramName + "!";
  // Auto-fill name if available
  if (telegramName && !document.getElementById("name").value) {
    document.getElementById("name").value = telegramName;
  }
} else {
  debugBox.className = "debug debug-red";
  debugBox.innerHTML = "‚ö†Ô∏è Open this app from your Telegram bot";
}

// Set minimum date to today
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
document.getElementById("date").min = yyyy + '-' + mm + '-' + dd;
document.getElementById("date").value = yyyy + '-' + mm + '-' + dd;

// Booking state
let selectedDuration = null;
let selectedTime = null;
let selectedCourts = null;

// Available hours
const availableHours = [
  "08:00", "09:00", "10:00", "11:00", "12:00",
  "13:00", "14:00", "15:00", "16:00", "17:00",
  "18:00", "19:00", "20:00", "21:00"
];

function clearActiveButtons(container) {
  const buttons = container.querySelectorAll("button");
  buttons.forEach(function(btn) {
    btn.classList.remove("active");
  });
}

function selectDuration(btn, hours) {
  selectedDuration = hours;
  selectedTime = null;
  clearActiveButtons(btn.parentNode);
  btn.classList.add("active");
  renderTimeButtons();
  updatePrice();
  updateConfirmButton();
}

function renderTimeButtons() {
  const container = document.getElementById("timeBtns");
  container.innerHTML = "";
  
  if (!selectedDuration) {
    container.innerHTML = '<span style="color:#64748b; font-size:14px; grid-column: span 2; text-align: center; padding: 8px;">Select duration first</span>';
    return;
  }
  
  // Calculate max start time based on duration (last slot is 21:00)
  const maxStartIndex = availableHours.length - selectedDuration;
  
  for (let i = 0; i <= maxStartIndex; i++) {
    const timeSlot = availableHours[i];
    const btn = document.createElement("button");
    btn.textContent = timeSlot;
    btn.onclick = function() {
      clearActiveButtons(container);
      this.classList.add("active");
      selectedTime = timeSlot;
      updateConfirmButton();
    };
    container.appendChild(btn);
  }
}

function selectCourts(btn, num) {
  selectedCourts = num;
  clearActiveButtons(btn.parentNode);
  btn.classList.add("active");
  updatePrice();
  updateConfirmButton();
}

function updatePrice() {
  const priceDisplay = document.getElementById("priceDisplay");
  if (selectedDuration && selectedCourts) {
    const total = selectedDuration * selectedCourts * 15;
    priceDisplay.textContent = "$" + total;
  } else {
    priceDisplay.textContent = "$0";
  }
}

function updateConfirmButton() {
  const btn = document.getElementById("confirmBtn");
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const date = document.getElementById("date").value;
  
  if (name && phone && date && selectedDuration && selectedTime && selectedCourts) {
    btn.disabled = false;
    const total = selectedDuration * selectedCourts * 15;
    btn.textContent = "Confirm Booking ‚Ä¢ $" + total;
  } else {
    btn.disabled = true;
    btn.textContent = "Select all options to book";
  }
}

// Add event listeners for input fields
document.getElementById("name").addEventListener("input", updateConfirmButton);
document.getElementById("phone").addEventListener("input", updateConfirmButton);
document.getElementById("date").addEventListener("change", updateConfirmButton);

function showLoading(show) {
  const overlay = document.getElementById("loadingOverlay");
  if (show) {
    overlay.classList.add("show");
  } else {
    overlay.classList.remove("show");
  }
}

async function confirmBooking() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const date = document.getElementById("date").value;
  
  if (!name || !phone || !date || !selectedDuration || !selectedTime || !selectedCourts) {
    tg.showAlert("Please fill in all fields and select all options.");
    return;
  }
  
  const confirmBtn = document.getElementById("confirmBtn");
  confirmBtn.disabled = true;
  confirmBtn.textContent = "Processing...";
  showLoading(true);
  
  const bookingData = {
    name: name,
    phone: phone,
    date: date,
    time: selectedTime,
    duration: selectedDuration,
    courts: selectedCourts,
    telegramUserId: telegramUserId
  };
  
  try {
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(bookingData),
      redirect: "follow"
    });
    
    let result;
    try {
      result = await response.json();
    } catch (parseError) {
      // If we can't parse JSON, assume success (no-cors fallback)
      result = { success: true };
    }
    
    showLoading(false);
    
    if (result.success) {
      tg.showAlert("‚úÖ Booking confirmed! Check your messages for details.");
      setTimeout(function() {
        tg.close();
      }, 1500);
    } else {
      // Show error message
      const errorMsg = result.error || "Booking failed. Please try again.";
      tg.showAlert("‚ùå " + errorMsg);
      confirmBtn.disabled = false;
      updateConfirmButton();
    }
    
  } catch (error) {
    showLoading(false);
    
    // Network error or CORS - try no-cors as fallback
    try {
      await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(bookingData),
        mode: "no-cors"
      });
      
      // With no-cors we can't read response, assume success
      tg.showAlert("‚úÖ Booking submitted! Check your messages for confirmation.");
      setTimeout(function() {
        tg.close();
      }, 1500);
      
    } catch (fallbackError) {
      tg.showAlert("‚ùå Connection error. Please check your internet and try again.");
      confirmBtn.disabled = false;
      updateConfirmButton();
    }
  }
}
</script>

</body>
</html>

