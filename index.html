<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TK Pickleball Booking</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui; background:#0f172a; color:#fff; padding:20px; margin:0; }
    h2 { margin-bottom:10px }
    .card { background:#1e293b; padding:16px; border-radius:12px; margin-bottom:12px }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px }
    button { padding:14px; border-radius:10px; border:none; background:#334155; color:#fff; font-size:16px; cursor:pointer; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    button.active { background:#22c55e; color:#000; font-weight:600 }
    button.confirm { background:#22c55e; color:#000; font-weight:bold; width:100%; margin-top:12px; }
    button.confirm:disabled { background:#666; }
    input { width:100%; padding:12px; border-radius:8px; border:none; font-size:16px; background:#fff; color:#000; }
    label { display:block; margin-bottom:8px; font-weight:500; }
    .loading { text-align:center; padding:20px; }
    .spinner { border:3px solid #334155; border-top:3px solid #22c55e; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    .error { background:#dc2626; padding:12px; border-radius:8px; margin-bottom:12px; }
    .success { background:#22c55e; color:#000; padding:16px; border-radius:12px; text-align:center; }
  </style>
</head>

<body>

<h2>üèì TK Pickleball Court Booking</h2>

<div id="errorBox" class="error" style="display:none;"></div>
<div id="successBox" class="success" style="display:none;"></div>

<div id="bookingForm">
  <div class="card">
    <label>Name</label>
    <input id="name" placeholder="Your name">
  </div>

  <div class="card">
    <label>Phone Number</label>
    <input id="phone" placeholder="Your phone number" type="tel">
  </div>

  <div class="card">
    <label>Date</label>
    <input type="date" id="date">
  </div>

  <div class="card">
    <label>Duration</label>
    <div class="grid">
      <button onclick="setDuration(this,1)">1 Hour</button>
      <button onclick="setDuration(this,2)">2 Hours</button>
      <button onclick="setDuration(this,3)">3 Hours</button>
    </div>
  </div>

  <div class="card">
    <label>Start Time</label>
    <div class="grid" id="timeBtns">
      <p style="color:#94a3b8; grid-column:span 2;">Select duration first</p>
    </div>
  </div>

  <div class="card">
    <label>Courts</label>
    <div class="grid">
      <button onclick="setCourts(this,1)">1 Court</button>
      <button onclick="setCourts(this,2)">2 Courts</button>
      <button onclick="setCourts(this,3)">3 Courts</button>
      <button onclick="setCourts(this,4)">4 Courts</button>
    </div>
  </div>

  <button id="confirmBtn" class="confirm" onclick="confirmBooking()">
    Confirm ($15/hr ‚Ä¢ Pay on Arrival)
  </button>
</div>

<div id="loadingBox" class="loading" style="display:none;">
  <div class="spinner"></div>
  <p>Processing your booking...</p>
</div>

<script>
// ============================================
// CONFIGURATION - UPDATE THIS URL!
// ============================================
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbySlkS8Yb3ACIfh5izbul6FfwTxgzrWg4_SnEMHsC21JyiaC1V9fak4GQFP4w3FvyjYPw/exec";
// Example: "https://script.google.com/macros/s/AKfycb.../exec"

// ============================================
// TELEGRAM INITIALIZATION
// ============================================
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Get Telegram user data
const telegramUser = tg.initDataUnsafe?.user;
const telegramUserId = telegramUser?.id || "";
const telegramInitData = tg.initData || "";

console.log("Telegram User ID:", telegramUserId);
console.log("Telegram User:", telegramUser);

// Pre-fill name if available from Telegram
if (telegramUser) {
  const fullName = [telegramUser.first_name, telegramUser.last_name]
    .filter(Boolean)
    .join(" ");
  if (fullName) {
    document.getElementById("name").value = fullName;
  }
}

// Set minimum date to today
const today = new Date().toISOString().split('T')[0];
document.getElementById("date").setAttribute("min", today);

// ============================================
// BOOKING STATE
// ============================================
let duration = null;
let time = null;
let courts = null;

const hours = [
  "08:00","09:00","10:00","11:00","12:00","13:00",
  "14:00","15:00","16:00","17:00","18:00",
  "19:00","20:00","21:00"
];

// ============================================
// UI FUNCTIONS
// ============================================
function clearButtons(btns) {
  btns.forEach(b => b.classList.remove("active"));
}

function showError(message) {
  const errorBox = document.getElementById("errorBox");
  errorBox.textContent = message;
  errorBox.style.display = "block";
  setTimeout(() => { errorBox.style.display = "none"; }, 5000);
}

function showLoading(show) {
  document.getElementById("bookingForm").style.display = show ? "none" : "block";
  document.getElementById("loadingBox").style.display = show ? "block" : "none";
}

function showSuccess() {
  document.getElementById("bookingForm").style.display = "none";
  document.getElementById("loadingBox").style.display = "none";
  document.getElementById("successBox").innerHTML = `
    <h3>‚úÖ Booking Confirmed!</h3>
    <p>Check your Telegram for booking details.</p>
    <p>This window will close shortly...</p>
  `;
  document.getElementById("successBox").style.display = "block";
}

function setDuration(btn, val) {
  duration = val;
  clearButtons([...btn.parentNode.children]);
  btn.classList.add("active");
  renderTimes();
}

function renderTimes() {
  const container = document.getElementById("timeBtns");
  container.innerHTML = "";
  time = null;

  for (let i = 0; i < hours.length - (duration - 1); i++) {
    const btn = document.createElement("button");
    btn.innerText = hours[i];
    btn.onclick = () => {
      clearButtons([...container.children]);
      btn.classList.add("active");
      time = hours[i];
    };
    container.appendChild(btn);
  }
}

function setCourts(btn, val) {
  courts = val;
  clearButtons([...btn.parentNode.children]);
  btn.classList.add("active");
}

// ============================================
// BOOKING SUBMISSION
// ============================================
async function confirmBooking() {
  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const date = document.getElementById("date").value;

  // Validation
  if (!name || !phone || !date || !duration || !time || !courts) {
    showError("Please fill all fields");
    return;
  }

  if (!telegramUserId) {
    showError("Telegram user not detected. Please open this from Telegram.");
    return;
  }

  showLoading(true);

  try {
    const response = await fetch(BACKEND_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        action: "book",
        date: date,
        time: time,
        duration: duration,
        courts: courts,
        name: name,
        phone: phone,
        telegramUserId: telegramUserId,
        telegramInitData: telegramInitData
      }),
      mode: "cors"
    });

    const result = await response.json();

    if (result.success) {
      showSuccess();
      // Close WebApp after showing success
      setTimeout(() => {
        tg.close();
      }, 2000);
    } else {
      showLoading(false);
      showError(result.error || "Booking failed. Please try again.");
    }

  } catch (error) {
    console.error("Booking error:", error);
    showLoading(false);
    showError("Connection error. Please try again.");
  }
}
</script>

</body>
</html>
